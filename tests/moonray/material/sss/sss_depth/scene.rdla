rats_assets_dir = os.getenv("RATS_ASSETS_DIR")

SceneVariables {
    ["pixel_samples"] = 2,
    ["image_width"] = 256,
    ["image_height"] = 256,
    ["max_depth"] = 5,  -- Int
    ["max_diffuse_depth"] = 5,  -- Int
    ["max_glossy_depth"] = 5,  -- Int
    ["max_mirror_depth"] = 5,  -- Int
    ["max_subsurface_per_path"] = 5  -- Int
}

Camera("/Scene/rendering/camera") {}

--------------------- Lights ----------------------------------

env = EnvLight("/Scene/lighting/env") {
    ["node_xform"] = rotate(270, 0, 1, 0),
    ["intensity"] = 0.8,
    ["exposure"] = 0.0,
    ["texture"] = rats_assets_dir .. "/hdri/parkinglot_dusk.exr",
}

key = RectLight("/Scene/lighting/key") {
    ["node_xform"] = translate(0, 0, 100) *
                     rotate(-60, 1, 0, 0) *
                     rotate(-60, 0, 1, 0),
    ["intensity"] = 16,
    ["exposure"] = 0.0,
    ["color"] = Rgb(0.855, 0.77, 0.535),
    ["width"] = 50,
    ["height"] = 50,
}

local lightSet = LightSet("/Scene/lighting/lightSet") {
    env,
    key,
}

--------------------- Geometry ----------------------------------

local geom1 = UsdGeometry("/Scene/geometry/geom/widget_DWA1") {
    ["node_xform"] = rotate(-35, 0, 1, 0) * translate(0, -3.7, -13),
    ["stage"] = rats_assets_dir .. "/models/MoonRayWidget.usdc",
    ["prim_path"] = "/widget",
}

local geom2 = UsdGeometry("/Scene/geometry/geom/widget_DWA2") {
    ["node_xform"] = rotate(-35, 0, 1, 0) * translate(0, -3.7, -13),
    ["stage"] = rats_assets_dir .. "/models/MoonRayWidget.usdc",
    ["prim_path"] = "/widget",
}

------------------------ Materials -------------------------------

local tx1 = ImageNormalMap("/Scene/surfacing/map/tx1") {
    ["tangent_space_normal_texture"] = rats_assets_dir .. "/textures/chesterfield.tx",
    ["scale"] = Vec2(3, 3),
}

local solidDielectric = DwaSolidDielectricMaterial("/Scene/surfacing/mtl/sd") {
    ["show_specular"] = false,
    ["albedo"] = Rgb(0.09, 0.09, 0.09),
    ["roughness"] = 0.55,
    ["specular_model"] = 0,
    ["refractive_index"] = 1.4,
    ["scattering_radius"] = .5,
    ["scattering_color"] = Rgb(.1, 0.4, .1),
    ["input_normal"] = tx1,
    ["bssrdf"] = 0, 
    ["enable_sss_input_normal"] = true
}

local solidDielectric2 = DwaSolidDielectricMaterial("/Scene/surfacing/mtl/sd2") {
    ["show_specular"] = false,
    ["albedo"] = Rgb(0.3, 0.2, 0.15),
    ["roughness"] = 0.55,
    ["specular_model"] = 0,
    ["refractive_index"] = 1.4,
    ["scattering_radius"] = 0.1,
    ["scattering_color"] = Rgb(1.0, 0.4, 0.4),
    ["input_normal"] = tx1,
    ["bssrdf"] = 0, 
    ["enable_sss_input_normal"] = false
}

local metal = DwaMetalMaterial("/Scene/surfacing/metal") {
    ["roughness"] = 0.1,
    ["specular_model"] = 0,
}

-----------------------------------------------------------------------------

GeometrySet("Scene/geometrySet") {
    geom1,
    geom2
}

Layer("/Scene/layer") {
    {geom1, "shell_front", metal, lightSet},
    {geom1, "shell_back", metal, lightSet},
    {geom1, "collar", solidDielectric, lightSet},
    {geom2, "stand", solidDielectric2, lightSet},
    {geom2, "core", solidDielectric2, lightSet},
}
