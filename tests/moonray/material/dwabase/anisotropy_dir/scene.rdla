rats_assets_dir = os.getenv("RATS_ASSETS_DIR")

frame = 101

-- Spin test: 101..300
modelRot = 360.0 * (math.min(frame, 201) - 101) / 100
lightRot = 360.0 * (math.max(frame, 201) - 201) / 100

SceneVariables {
    ["pixel_samples"] = 3,
    ["bsdf_samples"] = 3,
    ["bssrdf_samples"] = 0,
    ["max_depth"] = 10,
    ["image_width"] = 256,
    ["image_height"] = 256,
    ["sample_clamping_value"] = 6,
    ["sample_clamping_depth"] = 1,
    ["roughness_clamping_factor"] = 0.0, --1.12,
}

Camera("/Scene/rendering/camera") {
    ["node_xform"] = translate(0, 0.6, 3.7) * rotate(-30, 1, 0, 0),
}

-------------------------------------------------------

env = EnvLight("/Scene/lighting/env") {
    ["node_xform"] = rotate(lightRot, 0, 1, 0),
    ["exposure"] = -1,
    ["texture"] = rats_assets_dir .. "/hdri/parkinglot_dusk.exr",
}

key = RectLight("/Scene/lighting/key") {
    ["node_xform"] = translate(0, 0, 100) *
                     rotate(-60, 1, 0, 0) *
                     rotate(-60, 0, 1, 0) *
                     rotate(lightRot, 0, 1, 0),
    ["intensity"] = 10,
    ["exposure"] = -0.5,
    ["color"] = Rgb(0.855, 0.77, 0.535),
    ["width"] = 50,
    ["height"] = 50,
}

lightSet = LightSet("/Scene/lighting/lightSet") {
    env,
    key,
}

-------------------------------------------------------

local geom = UsdGeometry("/Scene/geometry/geom") {
    ["node_xform"] = rotate(modelRot, 0, 1, 0) * scale(0.24, 0.24, 0.24) * translate(0, -0.06, 0),
    ["stage"] = rats_assets_dir .. "/models/MoonRayWidget.usdc",
    ["prim_path"] = "/widget"
}

local dirMap = ImageMap("/Scene/surfacing/dirMap") {
    ["texture"] = rats_assets_dir .. "/textures/disk_pattern.tx",
    ["scale"] = Vec2(10, 10),
}

local mtl = DwaBaseMaterial("/Scene/surfacing/mtl") {
    ["albedo"] = Rgb(0,0,0),
    ["roughness"] = 0.7,
    ["metallic"] = 1.0,
    ["metallic_color"] = Rgb(1, 0.841722, 0.209112),
    ["anisotropy"] = -0.6,
    ["shading_tangent"] = bind(dirMap, Vec2(1, 1)),
}

-------------------------------------------------------

local planeGeom = UsdGeometry("/Scene/geometry/planeGeom") {
    ["node_xform"] = scale(15, 1, 15),
    ["stage"] = rats_assets_dir .. "/models/plane.usdc",
    ["prim_path"] = "/plane"
}

local planeMap = ImageMap("/Scene/surfacing/planeMap") {
    ["texture"] = rats_assets_dir .. "/textures/color_grid.tx",
    ["scale"] = Vec2(10, 10),
    ["offset"] = Vec2(0, .25),
    ["wrap_around"] = true,
}

local planeMtl = DwaBaseMaterial("/Scene/surfacing/planeMtl") {
    ["show_diffuse"] = true,
    ["albedo"] = bind(planeMap),
    ["specular"] = 0,
}

-------------------------------------------------------

GeometrySet("Scene/geometrySet") {
    geom,
    planeGeom
}

Layer("/Scene/layer") {
    {geom, "shell_front", mtl, lightSet},
    {geom, "shell_back", mtl, lightSet},
    {geom, "collar", mtl, lightSet},
    {geom, "stand", mtl, lightSet},
    {geom, "core", mtl, lightSet},
    {planeGeom, "", planeMtl, lightSet}
}
