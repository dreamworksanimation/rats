rats_assets_dir = os.getenv("RATS_ASSETS_DIR")

SceneVariables {
    ["image_width"] = 400,
    ["image_height"] = 400,
    ["pixel_samples"] = 4,
}

PerspectiveCamera("camera") {
    ["node_xform"] = translate(-4.9, 2.7, 18),
}

key = RectLight("key") {
    ["node_xform"] = translate(0, 0, 100) *
                     rotate(180, 1, 0, 0) *
                     rotate(0, 0, 1, 0),
    ["intensity"] = 4,
    ["color"] = Rgb(0.855, 0.77, 0.535),
    ["width"] = 10,
    ["height"] = 10,
}

lightSet = LightSet("lightSet") {
    key,
}


geoms = {}
assignments = {}

local posMin = -10
local posMax = 10

local roughnessMin = 0
local roughnessMax = 1

local offsetMin = -10
local offsetMax = 10

local azimRoughnessMin = 0
local azimRoughnessMax = 1

-- row wedges: 1=roughness, 2=offset, 3=azimRoughness
for row = 1, 3 do

    local numCol = 5
    for col = 1, numCol do
        local ratio = (col - 1) / (numCol - 1)
        
        local posX = posMin + (posMax - posMin) * ratio * 0.5
        
        local roughness = 0.5
        local offset = -3
        local azimRoughness = 0.75
        
        if row == 1 then
            posY = 7.2
            roughness = roughnessMin + (roughnessMax - roughnessMin) * ratio
        elseif row == 2 then
            posY = 2.4
            offset = offsetMin + (offsetMax - offsetMin) * ratio
        elseif row == 3 then
            posY = -2.4
            azimRoughness = azimRoughnessMin + (azimRoughnessMax - azimRoughnessMin) * ratio
        end

        local geom = UsdGeometry("geom" .. row .. "-" .. col) {
            ["node_xform"] = translate(posX, posY, 0),
            ["stage"] = rats_assets_dir .. "/models/hair_lock.usdc",
            ["prim_path"] = "/hair",
        }
        table.insert(geoms, geom)

        local mtl = HairMaterial_v3("mtl" .. row .. "-" .. col) {
            ["hair_color"] = Rgb(0.64, 0.12, 0.0),
            ["use_independent_transmission_roughness"] = true,
            ["independent_transmission_roughness"] = roughness,
            ["transmission_azimuthal_roughness"] = azimRoughness,
            ["show_primary_specular"] = false,
            ["show_secondary_specular"] = false,
            ["show_multiple_scattering"] = false,
            ["use_optimized_sampling"] = false

        }
        table.insert(assignments, {geom, "", mtl, lightSet})
    end
end

GeometrySet("geometrySet")(geoms)
Layer("layer")(assignments)
