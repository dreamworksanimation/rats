rats_assets_dir = os.getenv("RATS_ASSETS_DIR")

SceneVariables {
    ["pixel_samples"] = 4,
    ["light_samples"] = 1,
    ["bssrdf_samples"] = 0,
    ["max_depth"] = 10,
    ["max_glossy_depth"] = 4,
    ["max_mirror_depth"] = 4,
    ["russian_roulette_threshold"] = 0.0001,
    ["image_width"] = 400,
    ["image_height"] = 224,
}

ImageMap("/Scene/surfacing/text") {
    ["wrap_around"] = false,
    ["texture"] = rats_assets_dir .. "/textures/text-ure.tx",
}

-----------------------------------------------------------------------------

lens_mirror = UsdGeometry("/Scene/geometry/lens_mirror") {
    ["node_xform"] = Mat4(3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0.6, 0, -3.61881, 0.987119, 0, 1),
    ["stage"] = rats_assets_dir .. "/models/sphere.usdc",
    ["prim_path"] = "/sphere"
}

lens_glass = UsdGeometry("/Scene/geometry/lens_glass") {
    ["node_xform"] = Mat4(3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0.6, 0, -10.0358, 3, 0, 1),
    ["stage"] = rats_assets_dir .. "/models/sphere.usdc",
    ["prim_path"] = "/sphere"
}

box_glass = BoxGeometry("/Scene/geometry/box_glass") {
    ["node_xform"] = Mat4(5.71444, 0, 1.82899, 0, 0, 6, 0, 0, -0.152416, 0, 0.476203, 0, 10.8672, 3.01, 0, 1),
}

floor = UsdGeometry("/Scene/geometry/floor") {
    ["node_xform"] = Mat4(-30, 0, -3.67394e-15, 0, 0, 1, 0, 0, 2.44929e-15, 0, -20, 0, 0, 0, 0, 1),
    ["stage"] = rats_assets_dir .. "/models/plane.usdc",
    ["prim_path"] = "/plane"
}

box_mirror = BoxGeometry("/Scene/geometry/box_mirror") {
    ["node_xform"] = Mat4(5.71444, 0, 1.82899, 0, 0, 6, 0, 0, -0.152416, 0, 0.476203, 0, 3.46, 3.01, 0, 1),
}

wall_back = UsdGeometry("/Scene/geometry/wall_back") {
    ["node_xform"] = Mat4(30, 0, 0, 0, 0, 6.12323e-17, 1, 0, 0, -20, 1.22465e-15, 0, 0, 10, -10, 1),
    ["stage"] = rats_assets_dir .. "/models/plane.usdc",
    ["prim_path"] = "/plane"
}

lens_mirror2 = UsdGeometry("/Scene/geometry/lens_mirror2") {
    ["node_xform"] = Mat4(3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0.6, 0, -7.8358, 7.59, -4.15, 1),
    ["stage"] = rats_assets_dir .. "/models/sphere.usdc",
    ["prim_path"] = "/sphere"
}

GeometrySet("geometryset") {
    lens_mirror, 
    box_mirror,
    lens_mirror2,
    box_glass,
    floor,
    wall_back,
    lens_glass,
}

-----------------------------------------------------------------------------

glass_mat = DwaRefractiveMaterial("/Scene/surfacing/glass") {
    ["casts_caustics"] = true,
    ["roughness"] = 0.0,
    ["transmission_color"] = Rgb(0.82, 1, 0.759),
}

mirror_blue_mat = DwaMetalMaterial("/Scene/surfacing/mirror_blue") {
    ["roughness"] = 0,
}

floor_mat = DwaSolidDielectricMaterial("/Scene/surfacing/floor") {
    ["albedo"] = bind(ImageMap("/Scene/surfacing/text"), Rgb(1, 1, 1)),
    ["roughness"] = 0.8,
    ["refractive_index"] = 1.4,
}

wall_mat = DwaMetalMaterial("/Scene/surfacing/wall") {
    ["roughness"] = 0.173205,
}

-------------------------------------------------------------------

EnvLight("/Scene/lighting/env") {
    ["exposure"] = -1,
    ["texture"] = rats_assets_dir.."/hdri/parkinglot.exr",
}

lightSet = LightSet("lightSet") {
    EnvLight("/Scene/lighting/env"),
}

-------------------------------------------------------------------

Layer("/Scene/rendering/org/perPartitionAssignments") {
    {lens_glass, "", glass_mat, lightSet},
    {wall_back, "", wall_mat, lightSet},
    {floor, "", floor_mat, lightSet},
    {box_glass, "", glass_mat, lightSet},
    {lens_mirror2, "", mirror_blue_mat, lightSet},
    {box_mirror, "", mirror_blue_mat, lightSet},
    {lens_mirror, "", mirror_blue_mat, lightSet},
}
