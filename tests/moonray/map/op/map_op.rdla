SceneVariables {
    ["pixel_samples"] = 1,
    ["image_width"] = 400,
    ["image_height"] = 400,
}

PerspectiveCamera("camera") {
    ["node_xform"] = translate(0, 0.0, 10.0),
}

lightSet = LightSet("/Scene/lighting/lightSet") { }

-- Operations advance from the bottom left corner across and then up to the next line
-- Operations:
-- 0 = add
-- 1 = subtract
-- 2 = multiply
-- 3 = divide
-- 4 = maximum
-- 5 = minimum
-- 6 = power
-- 7 = cross
-- 8 = dot
-- 9 = invert op1
-- 10 = normalize op1
-- 11 = op1
-- 12 = op2
-- 13 = overlay
-- 14 = screen
-- 15 = abs
-- 16 = ceil
-- 17 = floor
-- 18 = modulo
-- 19 = fraction
-- 20 = length
-- 21 = sine
-- 22 = cosine
-- 23 = round
-- 24 = acos
-- 25 = less_than
-- 26 = less_than_or_equal
-- 27 = greater_than
-- 28 = greater_than_or_equal
-- 29 = equal
-- 30 = not equal
-- 31 = and
-- 32 = or
-- 33 = not
-- 34 = xor
-- 35 = bit_shift_left
-- 36 = bit_shift_right
-- 37 = bitwise_and
-- 38 = bitwise_or

geoms = {}
assignments = {}

numCol = 7 
numRow = 7 
numOps = 38
operation = 0
spacingX = 1.1
spacingY = 1.1
posXMin = -((numCol - 1) * spacingX) / 2.0
posYMin = -((numRow - 1)* spacingY) / 2.0
op1_factor = 1.0
op2_factor = 1.0

stage = rats_assets_dir.."/models/plane.usdc"
prim_path = "/plane"

-- First we test all of the operations and then we test the
-- op factors until we run out of rows/columns

i = 0
posY = posYMin
for row = 0, (numRow - 1) do
    posX = posXMin
    for col = 0, (numCol - 1) do

        colT = col / numCol
        rowT = row / numRow

        geom = UsdGeometry("geom" .. row .. "-" .. col) {
            ["node_xform"] = rotate(90, 1, 0, 0) * translate(posX, posY, 0),
            ["stage"] = stage,
            ["prim_path"] = prim_path,
        }
        table.insert(geoms, geom)

        opMap = OpMap("opMap" .. row .. "-" .. col) {
           ["operation"] = operation,
           ["op1"] = Rgb(1.0, 0.0, 0.0),
           ["op1_factor"] = op1_factor,
           ["op2"] = Rgb(0.0, 1.0, 0.0),
           ["op2_factor"] = op2_factor,
        }

        mtl = DwaEmissiveMaterial("mtl" .. row .. "-" .. col) {
            ["emission"] = bind(opMap, Rgb(1,1,1)),
        }
        table.insert(assignments, {geom, "", mtl, lightSet})

        posX = posX + spacingX 

        i = i + 1
        if (i >= numOps) then
            -- test op factors after testing the operations
            operation = 0
            op1_factor = 0.5
            op2_factor = 0.5
        else
            operation = i
        end

    end

    posY = posY + spacingY
end

GeometrySet("Scene/geometrySet")(geoms)
Layer("/Scene/layer")(assignments)
