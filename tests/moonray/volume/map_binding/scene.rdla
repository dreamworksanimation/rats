rats_assets_dir = os.getenv("RATS_ASSETS_DIR")

-- There are two overlapping volumes in this scene. The vdb volume is static and the box (rdlMesh) volume has motion blur.
-- Both have the same OpenVdbMap shader bound to their densities.

SceneVariables {
    ["image_width"] = 512,
    ["image_height"] = 256,
    ["enable_motion_blur"] = true,
    ["pixel_samples"] = 2,
    ["volume_overlap_mode"] = "rnd",
}

PerspectiveCamera("/interactive/camera") {
    ["mb_shutter_close"] = 0.0,
    ["mb_shutter_open"] = -1.0,
    ["node_xform"] = translate(-2, 0, 10),
}

EnvLight("/sceneflow_gaffer3/lgt_0") {
}

LightSet("/Scene/lightset/1") {
    EnvLight("/sceneflow_gaffer3/lgt_0"),
}

vel = 7

box = RdlMeshGeometry("/Scene/geometry/box") {
    ["node_xform"] = scale(15, 20, 8) * translate(-7, -10, -5),
    ["vertex_list"] = {Vec3(0, 0, 0), Vec3(0, 1, 0), Vec3(1, 1, 0), Vec3(1, 0, 0),
                       Vec3(0, 1, 1), Vec3(0, 0, 1), 
                       Vec3(1, 0, 1), Vec3(1, 1, 1)}, 
    ["vertices_by_index"] = {0, 1, 2, 3,
                             1, 0, 5, 4,
                             0, 3, 6, 5,
                             4, 5, 6, 7,
                             7, 6, 3, 2,
                             1, 4, 7, 2},
    ["face_vertex_count"] = {4, 4, 4, 4, 4, 4},
    ["side_type"] = 0,
    ["is_subd"] = false,
    ["velocity_list"] = { Vec3(vel, 0, 0), Vec3(vel, 0, 0), Vec3(vel, 0, 0),
                          Vec3(vel, 0, 0), Vec3(vel, 0, 0), Vec3(vel, 0, 0),
                          Vec3(vel, 0, 0), Vec3(vel, 0, 0)},
    ["motion_blur_type"] = "velocity",
}

VdbGeometry("/obj/noisebox_vdb") {
    ["node_xform"] = translate(0, -10, 0) * scale(0.2, 0.2, 0.2),
    ["model"] = rats_assets_dir.."/models/noise_box.vdb",
    ["velocity_grid"] = "v",
}

GeometrySet("/Scene/geoset") {
    VdbGeometry("/obj/noisebox_vdb"),
    box,
}

densityMap = OpenVdbMap("/obj/SceneFlow/sceneflow_shader_assign/shader/density") {
    ["texture"] = rats_assets_dir.."/models/sphere.vdb",
}

VdbVolume("/mat/VdbVolume") {
    ["color_mult"] = bind(densityMap),
    ["bake_resolution_mode"] = 1,
    ["bake_divisions"] = 100,
    ["opacity_gain_mult"] = bind(densityMap),
}

BaseVolume("/mat/BaseVolume") {
    ["attenuation_intensity"] = bind(densityMap),
    ["attenuation_color"] = Rgb(0.1,0.3,0.8),
}

Layer("/Scene/layer") {
    {VdbGeometry("/obj/noisebox_vdb"), {""}, LightSet("/Scene/lightset/1"), VdbVolume("/mat/VdbVolume")},
    {box, "", LightSet("/Scene/lightset/1"), BaseVolume("/mat/BaseVolume")},
}

