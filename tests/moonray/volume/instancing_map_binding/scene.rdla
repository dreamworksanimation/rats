rats_assets_dir = os.getenv("RATS_ASSETS_DIR")


SceneVariables {
    ["image_width"] = 256,
    ["image_height"] = 256,
    ["enable_motion_blur"] = true,
    ["pixel_samples"] = 2,
    ["volume_overlap_mode"] = "rnd",
}

PerspectiveCamera("/interactive/camera") {
    ["mb_shutter_close"] = 0.0,
    ["mb_shutter_open"] = -1.0,
    ["node_xform"] = translate(0, -2.5, 15),
}

EnvLight("/sceneflow_gaffer3/lgt_0") {
}

lights = LightSet("/Scene/lightset/1") {
    EnvLight("/sceneflow_gaffer3/lgt_0"),
}

densityMap = OpenVdbMap("/obj/SceneFlow/sceneflow_shader_assign/shader/density") {
    ["texture"] = rats_assets_dir.."/models/sphere.vdb",
}

VdbVolume("/mat/VdbVolume") {
    ["color_mult"] = bind(densityMap),
    ["bake_resolution_mode"] = 1,
    ["bake_divisions"] = 200,
    ["opacity_gain_mult"] = bind(densityMap),
}

BaseVolume("/mat/BaseVolume") {
    ["attenuation_intensity"] = bind(densityMap),
    ["attenuation_color"] = Rgb(0.1,0.3,0.8),
}

vel = 7 * 15

VdbGeometry("/obj/noisebox_vdb") {
    ["model"] = rats_assets_dir.."/models/noise_box.vdb",
    ["velocity_grid"] = "v",
}

box = RdlMeshGeometry("/box") {
    ["vertex_list"] = {Vec3(-7, -20, -5), Vec3(-7, 20, -5), Vec3(8, 20, -5), Vec3(8, -20, -5),
                       Vec3(-7, 20, 3), Vec3(-7, -20, 3),
                       Vec3(8, -20, 3), Vec3(8, 20, 3)},
    ["vertices_by_index"] = {0, 1, 2, 3,
                             1, 0, 5, 4,
			     0, 3, 6, 5,
			     4, 5, 6, 7,
			     7, 6, 3, 2,
			     1, 4, 7, 2},
   ["face_vertex_count"] = {4, 4, 4, 4, 4, 4},
   ["is_subd"] = false,
   ["velocity_list"] = { Vec3(vel, 0, 0), Vec3(vel, 0, 0), Vec3(vel, 0, 0),
      			 Vec3(vel, 0, 0), Vec3(vel, 0, 0), Vec3(vel, 0, 0),
      			 Vec3(vel, 0, 0), Vec3(vel, 0, 0)},
   ["motion_blur_type"] = "velocity",
}

instancer0 = RdlInstancerGeometry("/instancer0)") {
   ["references"] = { box, VdbGeometry("/obj/noisebox_vdb") },
   ["method"] = "xform list",
   ["xform_list"] = { translate(-3, 0, 0),
		      translate(3, 0, 0),
		      translate(0, -3, 0),
		      translate(0, -3, 0),
		      rotate(30, 0, 0, 1) * translate(-3, -6, 0),
		      scale(1.5, 1.5, 1.5) * translate(3, -6, 0)
   },
   ["refIndices"] = { 0, 1, 0, 1, 1, 1 }
}

GeometrySet("/geometrySet") {
    instancer0
}

Layer("/layer") {
    {VdbGeometry("/obj/noisebox_vdb"), "", lights, VdbVolume("/mat/VdbVolume")},
    {box, "", lights, BaseVolume("/mat/BaseVolume")},
    {instancer0, "", lights}
}

