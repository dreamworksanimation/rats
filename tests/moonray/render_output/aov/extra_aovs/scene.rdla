rats_assets_dir = os.getenv("RATS_ASSETS_DIR")

SceneVariables {
    ["image_width"] = 480,
    ["image_height"] = 270,
    ["pixel_samples"] = 2
}

Camera("/Scene/rendering/camera") {
    ["node_xform"] = rotate(-28, 1, 0, 0) * rotate(-36, 0, 1, 0) * translate(-29, 25, 40),
}

---------------------- Lights ---------------------------------

env = EnvLight("/Scene/lighting/env") {
    ["intensity"] = 0.2,
    ["color"] = Rgb(0.217, 0.268, 0.325),
    ["texture"] = rats_assets_dir .. "/hdri/parkinglot_dusk.exr",
}

key = SphereLight("/Scene/lighting/key") {
    ["node_xform"] = translate(20, 20, -5),
    ["color"] = Rgb(0.855, 0.77, 0.535),
}

lightSet = LightSet("/Scene/lighting/lightSet") {
    env,
    key,
}

---------------------- Geometry -------------------------------

cube = BoxGeometry("/cube") {
    ["node_xform"] = scale(16, 16, 16)
}

plane = UsdGeometry("/plane") {
    ["node_xform"] = scale(1000, 1000, 1000) * translate(0, -10, 100),
    ["stage"] = rats_assets_dir .. "/models/plane.usdc",
    ["prim_path"] = "/plane",
}

torusCd = UserData("/Scene/geometry/torusCd") {
    ["color_key"] = "Cd",
    ["color_values_0"] = { Rgb(0, 0, 1) },
}

torus = UsdGeometry("/Scene/geometry/torus") {
    ["node_xform"] = rotate(90, 1, 0, 0) * scale(6, 6, 6),
    ["stage"] = rats_assets_dir .. "/models/torus.usdc",
    ["prim_path"] = "/torus",
    ["primitive_attributes"] = { torusCd },
}

---------------------- Materials ---------------------------------

planeMtl = DwaSolidDielectricMaterial("planeMtl") {
    ["specular_model"] = 0,
}

-- glass transmission matte gets <1, 1, 1>
glassTransmissionMatteMap = ConstantColorMap("glassTransmissionMatteMap") {}

glassTransmissionMatteAov = ExtraAovMap("glassTransmissionMatteAov") {
    ["label"] = "glass_transmission_matte",
    ["color"] = bind(glassTransmissionMatteMap),
    ["post_scatter"] = true
}

glassTransmissionExtraAovsList = ListMap("glassTransmissionExtraAovsList") {
    ["map0"] = glassTransmissionMatteAov
}

glass = DwaRefractiveMaterial("glass") {
    ["roughness"] = 0.3,
    ["specular_model"] = 0,
    ["casts_caustics"] = true,
    ["extra_aovs"] = glassTransmissionExtraAovsList
}

torusMatteMap = AttributeMap("torusExtraMap") {
    ["map_type"] = "primitive attribute",
    ["primitive_attribute_name"] = "Cd", -- this is the default
    ["primitive_attribute_type"] = "rgb"
}

torusMatteAov = ExtraAovMap("/Scene/ExtraAovs/torusMatte") {
    ["label"] = "torus_matte",
    ["color"] = bind(torusMatteMap),
}

torusMtlExtraAovsList = ListMap("torusMtlExtraAovsList") {
    ["map0"] = torusMatteAov
}

torusMtl = DwaSolidDielectricMaterial("torusMtl") {
    ["albedo"] = Rgb(0.8, 0.8, 0.4),
    ["extra_aovs"] = torusMtlExtraAovsList,
    ["specular_model"] = 0,
}

-----------------------------------------------------------

GeometrySet("Scene/geometrySet") {
    cube, 
    plane,
    torus,
}

Layer("/Scene/layer") {
    {cube, "", glass, lightSet},
    {plane, "", planeMtl, lightSet},
    {torus, "", torusMtl, lightSet},
}

-------------------- Render Outputs -----------------------

RenderOutput("/Scene/output/torusMatteNumerator") {
    ["file_name"] = "torus_matte_num.exr",
    ["result"] = "light aov",
    ["light_aov"] = "CT'U:torus_matte'",
    ["channel_name"] = "torus_matte_num",
    ["math_filter"] = "sum"
}

RenderOutput("/Scene/output/torusMatteDenominator") {
    ["file_name"] = "torus_matte_denom.exr",
    ["result"] = "light aov",
    ["light_aov"] = "CT'U:glass_transmission_matte'",
    ["channel_name"] = "torus_matte_denom",
    ["math_filter"] = "sum"
}

-- some extra interesting aovs
RenderOutput("/Scene/output/oneBounce") {
    ["file_name"] = "result0.exr",
    ["result"] = "light aov",
    ["light_aov"] = "C[RT]'U:torus_matte'"
}

RenderOutput("/Scene/output/twoBounce") {
    ["file_name"] = "result0.exr",
    ["result"] = "light aov",
    ["light_aov"] = "C[RT][RT]'U:torus_matte'"
}

RenderOutput("/Scene/output/threeBounce") {
    ["file_name"] = "result0.exr",
    ["result"] = "light aov",
    ["light_aov"] = "C[RT][RT][RT]'U:torus_matte'"
}

RenderOutput("/Scene/output/tourusMatteMin") {
    ["file_name"] = "result0.exr",
    ["result"] = "light aov",
    ["light_aov"] = "C[RT]'U:torus_matte'",
    ["channel_name"] = "tourusMatteMin",
    ["math_filter"] = "min"
}

RenderOutput("/Scene/output/tourusMatteMax") {
    ["file_name"] = "result0.exr",
    ["result"] = "light aov",
    ["light_aov"] = "C[RT]'U:torus_matte'",
    ["channel_name"] = "torusMatteMax",
    ["math_filter"] = "max"
}
