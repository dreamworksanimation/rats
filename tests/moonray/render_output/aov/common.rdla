rats_assets_dir = os.getenv("RATS_ASSETS_DIR")

SceneVariables {
    ["image_width"] = 630,
    ["image_height"] = 250,
    ["pixel_samples"] = 3,
    ["light_samples"] = 1,
    ["bsdf_samples"] = 1,
    ["bssrdf_samples"] = 2,
    ["roughness_clamping_factor"] = 2
}

Camera("/camera") {
    ["node_xform"] = translate(0.6, 0.65, 10.0) * rotate(-30, 1, 0, 0),
}

--------------------------- Lights ---------------------------

env = EnvLight("/envlight") {
    ["texture"] = rats_assets_dir .. "/hdri/parkinglot_dusk.exr",
    ["label"] = "key",
}

lightset = LightSet("/lightset") {
    env,
}

--------------------------- Geometry ---------------------------

gizmo1 = UsdGeometry("/gizmo1") {
    ["node_xform"] = scale(0.25, 0.25, 0.25) * translate(-2.1, 0, 0),
    ["stage"] = rats_assets_dir .. "/models/MoonRayWidget.usdc",
    ["prim_path"] = "/widget",
    ["label"] = "gizmo1"
}

gizmo2 = UsdGeometry("/gizmo2") {
    ["node_xform"] = scale(0.25, 0.25, 0.25) * translate(0.0, 0, 0),
    ["stage"] = rats_assets_dir .. "/models/MoonRayWidget.usdc",
    ["prim_path"] = "/widget",
    ["label"] = "gizmo2"
}

gizmo3 = UsdGeometry("/gizmo3") {
    ["node_xform"] = scale(0.25, 0.25, 0.25) * translate(2.1, 0, 0),
    ["stage"] = rats_assets_dir .. "/models/MoonRayWidget.usdc",
    ["prim_path"] = "/widget",
    ["label"] = "gizmo3"
}

hair_lock = UsdGeometry("/curly") {
   ["node_xform"] = scale(0.5, 0.5, 0.5) * rotate(-20, 1, 0, 0) *  translate(3.8, 0.7, 0),
   ["stage"] = rats_assets_dir .. "/models/hair_lock.usdc",
   ["prim_path"] = "/hair",
   ["label"] = "curly"
}

GeometrySet("/geometrySet") {
    gizmo1,
    gizmo2,
    gizmo3,
    hair_lock,
}

-------------------------- Materials -------------------------------

--- Widget 1 Material ---

color_grid = ImageMap("/diffuseMap") {
    ["texture"] = rats_assets_dir .. "/textures/color_grid.tx",
}

plasticMtl = DwaSolidDielectricMaterial("/plasticClearcoat") {
    ["show_clearcoat"] = true,
    ["clearcoat_attenuation_color"] = Rgb(1, 0, 0),
    ["clearcoat_thickness"] = 0.07,
    ["clearcoat_roughness"] = 0.0,
    ["clearcoat_model"] = 0,
    ["specular_model"] = 0,
    ["albedo"] = bind(color_grid, Rgb(0.5,0.5,0.5)),
    ["translucent_diffuse"] = Rgb(0.2, 0.2, 0.2),
    ["roughness"] = 0.5,
    ["label"] = "plastic",
}

metalInnerMtl = DwaMetalMaterial("/metalInner") {
    ["roughness"] = 0.1,
    ["specular_model"] = 0,
    ["metallic_color"] = Rgb(0.955, 0.637, 0.538),
    ["metallic_edge_color"] = Rgb(0.955, 0.637, 0.538),
    ["label"] = "inner_metal",
}

--- Widget 2 Material ---

velvetMtl = DwaVelvetMaterial_v2("/velvet") {
    ["albedo"] = Rgb(0.1, 0.1, 0.02),
    ["fuzz_coverage"] = 0.03125,
    ["fuzz"] = 0.8,
}

metal_anti_slip_nrml = ImageNormalMap("/normalMap") {
    ["tangent_space_normal_texture"] = rats_assets_dir .. "/textures/metal_anti_slip.tx",
    ["scale"] = Vec2(8, 8),
    ["wrap_around"] = true,
}
metalOuterMtl = DwaMetalMaterial("/metalOuter") {
    ["metallic_color"] = Rgb(0.93, 0.9, 0.92),
    ["roughness"] = 0.4,
    ["specular_model"] = 0,
    ["anisotropy"] = 1.,
    ["input_normal"] = metal_anti_slip_nrml,
    ["input_normal_dial"] = 1.0,
}

indirectionLayerMtl = DwaLayerMaterial("/indirectionLayerMat") {
    ["material_A"] = velvetMtl,
    ["material_B"] = metalOuterMtl,
    ["mask"] = 0
}
    
noiseMap = NoiseMap_v2("/noiseMap") {
   ["frequency_multiplier"] = 0.5,
   ["max_level"] = 2,
   ["color_A"] = Rgb(0, 0, 0),
   ["use_smoothstep"] = true,
   ["smoothstep"] = Vec2(0.4, 0.75)
}
layerMtl = DwaLayerMaterial("/layerMaterial") {
    ["material_A"] = velvetMtl,
    ["material_B"] = indirectionLayerMtl,
    ["mask"] = bind(noiseMap, 1),
}

glitterMtl = DwaBaseMaterial("/glitter") {
    ["show_emission"] = true,
    ["emission"] = Rgb(0.15, 0.15, 1),
    ["show_diffuse"] = false,
    ["specular_model"] = 0,
    ["show_specular"] = false,
    ["show_glitter"] = true,
    ["glitter_color_A"] = Rgb(0.55, 0.55, 0.55),
    ["glitter_density"] = 6,
    ["glitter_size_A"] = 2/15,
    ["glitter_roughness_A"] = 0.1,
    ["glitter_space"] = 4,
    ["label"] = "flake",
}

--- Widget 3 Material ---

skinMtl = DwaSkinMaterial("/skinMaterial") {
    ["roughness"] = 0.5,
    ["specular_model"] = 0,
    ["albedo"] = Rgb(0.22, 0.12, 0.103),
    ["scattering_color"] = Rgb(1, 0.1, 0.1),
    ["scattering_radius"] = 0.6,
    ["show_moisture"] = true,
    ["moisture_mask"] = 0.75,
    ["moisture_refractive_index"] = 1.33,
    ["use_independent_moisture_normal"] = true,
    ["moisture_roughness"] = 0.2,
    ["moisture_model"] = 0,
}

fabricMtl = DwaFabricMaterial("/fabricMaterial") {
   ["warp_color"] = Rgb(0.4, 0.1, 0.1),
   ["warp_roughness"] = 0.5,
   ["albedo"] = Rgb(0.22, 0.12, 0.103),
   ["label"] = "fabric"
}

--- Hair Material ---

hairMtl = HairMaterial_v3("/hairMaterial") {
    ["hair_color"] = Rgb(0.087, 0.047, 0.03),
    ["primary_specular_roughness"] = 0.5,
    ["primary_specular_offset"] = -3.0,
    ["label"] = "hair1"
}

------------------------------------------------------------------------

outer_parts = {"shell_front", "shell_back", "collar"}
inner_parts = {"core", "stand"}

Layer("/layer") {
    {gizmo1, outer_parts, plasticMtl, lightset},
    {gizmo1, inner_parts, metalInnerMtl, lightset},
    {gizmo2, outer_parts, layerMtl, lightset},
    {gizmo2, inner_parts, glitterMtl, lightset},
    {gizmo3, outer_parts, skinMtl, lightset},
    {gizmo3, inner_parts, fabricMtl, lightset},
    {hair_lock, "", hairMtl, lightset},
}
