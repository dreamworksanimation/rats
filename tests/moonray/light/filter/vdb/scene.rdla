rats_assets_dir = os.getenv("RATS_ASSETS_DIR")

SceneVariables {
    ["lights_visible_in_camera"] = true,
    ["pixel_samples"] = 2,
    ["max_depth"] = 1,
    ["image_width"] = 360,
    ["image_height"] = 200,
}

Camera("/Scene/rendering/camera") {
    ["node_xform"] = Mat4(1, 0, 0, 0,
                          0, 1, 0, 0,
                          0, 0, 1, 0,
                          0, 1.5, 6, 1),
}

-- Geometry --

UsdGeometry("/Scene/geometry/widget1") {
    ["node_xform"] = scale(0.3, 0.3, 0.3) * translate(2.5, 0, -7),
    ["stage"] = rats_assets_dir.."/models/MoonRayWidget.usdc",
    ["prim_path"] = "/widget",
}

UsdGeometry("/Scene/geometry/widget2") {
    ["node_xform"] = scale(0.3, 0.3, 0.3) * translate(-2.5, 0, -7),
    ["stage"] = rats_assets_dir.."/models/MoonRayWidget.usdc",
    ["prim_path"] = "/widget",
}

UsdGeometry("/Scene/geometry/floor") {
    ["node_xform"] = scale(10, 10, 10) * translate(0, 0, -5),
    ["stage"] = rats_assets_dir.."/models/plane.usdc",
    ["prim_path"] = "/plane",
}

UsdGeometry("/Scene/geometry/wall") {
    ["node_xform"] = rotate(90, 1, 0, 0) * scale(10, 10, 10) * translate(0, 5, -10),
    ["stage"] = rats_assets_dir.."/models/plane.usdc",
    ["prim_path"] = "/plane",
}

GeometrySet("geometryset") {
    UsdGeometry("/Scene/geometry/widget1"),
    UsdGeometry("/Scene/geometry/widget2"),
    UsdGeometry("/Scene/geometry/floor"),
    UsdGeometry("/Scene/geometry/wall"),
}

-- Materials --

DwaSolidDielectricMaterial("/Scene/surfacing/floor") {
}

DwaSolidDielectricMaterial("/Scene/surfacing/object_widget") {
    ["albedo"] = Rgb(0.8, 0.5, 0.5),
    ["roughness"] = 0.1,
}

-- Lights --

local vdbTransform = scale(0.01, 0.05, 0.01) * translate(0, 0, -7)

filter = VdbLightFilter("/Scene/lighting/vdb") {
    ["node_xform"] = vdbTransform,
    ["vdb_map"] = rats_assets_dir.."/models/torus.vdb",    
    ["density_remap_outputs"] = { 0.0, 0.1, 0.2, 0.5, 1.0},
    ["density_remap_inputs"] = {0.0, 0.25, 0.5, 0.75, 1.0},
    ["density_remap_interpolation_types"] = {1, 1, 1, 1, 1},
    ["density_rescale_enable"] = true,
    ["density_grid_name"] = "density",
    ["vdb_interpolation_type"] = 2,
    ["blur_value"] = 0,
    ["blur_type"] = "circular",
    ["invert_density"] = true,
}

sun = DistantLight("/Scene/lighting/sun") {
    ["node_xform"] = Mat4(0.786774, 0.019432, -0.616936, 0, -0.525164, 0.546265, -0.652531, 0, 0.324331, 0.837387, 0.439992, 0, 13.7238, 7, 2.81431, 1),
    ["on"] = true,
    ["intensity"] = 1,
    ["normalized"] = true,
    ["color"] = Rgb(0.749, 0.748, 0.678),
    ["angular_extent"] = 5,
    ["light_filters"] = {filter},
}

lightSet = LightSet("LightSetA") {
    sun,
}

Layer("/Scene/rendering/organizer/perPartitionAssignments") {
    {UsdGeometry("/Scene/geometry/widget1"), "", DwaSolidDielectricMaterial("/Scene/surfacing/object_widget"), lightSet},
    {UsdGeometry("/Scene/geometry/widget2"), "", DwaSolidDielectricMaterial("/Scene/surfacing/object_widget"), lightSet},
    {UsdGeometry("/Scene/geometry/floor"), "", DwaSolidDielectricMaterial("/Scene/surfacing/floor"), lightSet},
    {UsdGeometry("/Scene/geometry/wall"), "", DwaSolidDielectricMaterial("/Scene/surfacing/floor"), lightSet},
}
