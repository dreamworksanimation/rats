rats_assets_dir = os.getenv("RATS_ASSETS_DIR")

DEFAULT_SCENE_SCALE = 0.01
SCENE_SCALE_MULTIPLIER = 0.25
SCENE_SCALE = DEFAULT_SCENE_SCALE * SCENE_SCALE_MULTIPLIER

SceneVariables {
    ["bssrdf_samples"] = 0,
    ["max_depth"] = 3,
    ["image_width"] = 480,
    ["image_height"] = 270,
    ["scene_scale"] = SCENE_SCALE,
}

Camera("/Scene/rendering/camera") {
    ["node_xform"] = translate(0, 0, 100 / SCENE_SCALE_MULTIPLIER)
                   * rotate(-10, 1, 0, 0)
                   * rotate(90, 0, 1, 0),
    ["focal"] = 100,
    ["dof"] = true,
    ["dof_aperture"] = 4.0,
    ["dof_focus_distance"] = 100 / SCENE_SCALE_MULTIPLIER,
}

-------------------------------------------------------

env = EnvLight("/Scene/lighting/env") {
    ["intensity"] = 0.8,
    ["texture"] = rats_assets_dir .. "/hdri/parkinglot_dusk.exr",
}

key = RectLight("/Scene/lighting/key") {
    ["node_xform"] = translate(0, 0, 100 / SCENE_SCALE_MULTIPLIER) *
                     rotate(-60, 1, 0, 0) *
                     rotate(-60, 0, 1, 0),
    ["intensity"] = 12,
    ["color"] = Rgb(0.855, 0.77, 0.535),
    ["width"] = 50 / SCENE_SCALE_MULTIPLIER,
    ["height"] = 50 / SCENE_SCALE_MULTIPLIER,
}

lightSet = LightSet("/Scene/lighting/lightSet") {
    env,
    key,
}

-------------------------------------------------------

geoms = {}
assignments = {}

local posXMin = -20
local posXMax = 20

local posZMin = 10
local posZMax = -10

local roughnessMin = 0.0
local roughnessMax = 1.0

local numCol = 11
for col = 1, numCol do
    local ratio = (col - 1) / (numCol - 1)
    local factor = 0.5

    --- interpolated values ---
    local posX = posXMin + (posXMax - posXMin) * ratio
    local posZ = posZMin + (posZMax - posZMin) * ratio

    local roughness = roughnessMin + (roughnessMax - roughnessMin) * ratio
    ----------------------------

    local geom = SphereGeometry("/Scene/geometry/geom" .. col) {
        ["node_xform"] = translate(posX, 1, posZ)
                       * scale(1 / SCENE_SCALE_MULTIPLIER, 1 / SCENE_SCALE_MULTIPLIER, 1 / SCENE_SCALE_MULTIPLIER),
    }
    table.insert(geoms, geom)

    local mtl = DwaBaseMaterial("/Scene/surfacing/mtl" .. col) {
        ["show_diffuse"] = false,
        ["metallic"] = factor,
        ["roughness"] = roughness,
    }
    table.insert(assignments, {geom, "", mtl, lightSet})
end

-------------------------------------------------------

local planeGeom = UsdGeometry("/Scene/geometry/planeGeom") {
    ["node_xform"] = scale(45, 1, 25) * 
                     scale(1 / SCENE_SCALE_MULTIPLIER, 1 / SCENE_SCALE_MULTIPLIER, 1 / SCENE_SCALE_MULTIPLIER),
    ["stage"] = rats_assets_dir .. "/models/plane.usdc",
    ["prim_path"] = "/plane",
}
table.insert(geoms, planeGeom)

local planeMap = ImageMap("/Scene/surfacing/planeMap") {
    ["texture"] = rats_assets_dir .. "/textures/color_grid.tx",
    ["scale"] = Vec2(7, 4),
    ["offset"] = Vec2(0, .25),
    ["wrap_around"] = true,
}

local planeMtl = DwaBaseMaterial("/Scene/surfacing/planeMtl") {
    ["albedo"] = bind(planeMap),
    ["specular"] = 0,
}
table.insert(assignments, {planeGeom, "", planeMtl, lightSet})

-------------------------------------------------------

GeometrySet("Scene/geometrySet")(geoms)
Layer("/Scene/layer")(assignments)

